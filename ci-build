#!/bin/sh

set -e

if test -z "$VIRTUAL_ENV"; then
  set -x
  virtualenv ci-build-venv
  . ci-build-venv/bin/activate
  python setup.py develop

  # requirement for integration tests
  pip install 'Flask==0.9'
fi

export LAVACONFIG=/dev/null

if test -z "$DISPLAY"; then
  # actual CI - will install tests dependencies automatically
  python setup.py test < /dev/null
else
  # in a development workstation, this will produce shorter/nicer output, but
  # requires the test dependencies to be installed manually (or by running
  # `python setup.py test` before).
  python -m unittest lava_tool.tests.test_suite < /dev/null
fi

./integration-tests
